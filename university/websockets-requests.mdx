---
title: 'Web Socket Requests'
description: 'Specification of the data that needs to be sent to the WebSocket connection to execute a given function. For each function, you can find the data structure and an example of a working command.'
icon: 'terminal'
---
* Values determined by the Server Stack are referred to as `[from METHOD /endpoint]`
* Values determined by the player are referred to as `[from client]`
* [Send requests](https://www.npmjs.com/package/ws?ref=blog.krum.io) to: `wss://w1ws57hjh0.execute-api.eu-central-1.amazonaws.com/prod/` 

## createGame
createGame creates an object in the elasticache-tax-game cache, with the key `${gameID}`. It also creates the first empty planet in the planets array (in the elasticache-tax-game cache with the key `planets`).

### Required data
```javascript
action: string //MUST BE "game" 
type: string //MUST BE "createGame" 
gameID: string //[from RestAPI]
stageTime: number //in seconds (eg: 20 = 20s | so a round will be 1m 20s)
auditChance: number //decimal (eg: 20% = 0.20)
finePercent: number //decimal (eg: 20% = 0.20)
pcm: number //decimal (eg: 1.7) | planet collection multiplier
defaultRate: number //decimal (eg: 20% = 0.20)
```

example: `{"action":"game","type":"createGame","gameID":"game-c3b4i7ybc","stageTime":20,"auditChance":0.25,"finePercent":0.15,"pcm":1.7,"defaultRate":0.30}`

### Elasticache
```javascript
`${gameID}`: {
    hostID: string,
    gameID: string,
    gameConfiguration: {
        stageTime: number,
        auditChance: number,
        finePercent: number,
        pcm: number,
        defaultRate: number,
      }
}

`planets-${gameID}` :[
  {
      planetID: string, //like "planet0", consecutive
      name: string, //AI generated, like "Valerion"
      taxRate: number, //starts as defaultRate
      players: [{
        connectionID: string, //player's connection id
        player_name: string,
        role: string // one of ["A" || "B" || "C"]
    }],
  },
]
```

### Returns

```javascript
    statusCode: 200,
    body: `["OK","OK"]`
```

## joinGame
joinGame creates an object in the elasticache-tax-game cache, with the key `${gameID}---${playerID}`. It will return a generated role and planet to each connection (once the planet is established), and update the host with the new player (playerID and name).

<Warning>When WebSockets receives the request, it scans `DynamoDBStack-WebsocketConnections87C62C57-1H8H09K1YWXHY` table. If there is a record in the table with the same connectionId & gameID, it gets that object from Elasticache and returns the full item to the user.</Warning>

### Required data
```javascript
action: string, //MUST BE "game" 
type: string, //MUST BE "joinGame" 
gameID: string, 
playerID: string, //from RestAPI [ POST /joinGame]
name: string //from client
```

example: `{"action":"game","type":"joinGame","gameID":"game-c3b4i7ybc","playerID":"001a","name":"Emma"}`

### New Connection
#### Elasticache: Role A
```javascript
`${gameID}---${playerID}`: {
    connectionId: string,
    playerID: string,
    name: string,
    role: string, // "A"
    wealth: Array<number>, //starts as [0]
    rank: Array<number>, //starts as [0]
    planet: string, //`${planetID},${planetName}`,
    taxRate: Array<number>, // ONLY A | starts as [defaultRate]
    redistributedWealth: Array<number>, // ONLY A | amount they redistributed to B and C players in a round
    playerCount: Array<number>, // ONLY A | number of players on the planet they are currently on 
    bankrupt: Array<boolean>, // - true if they went bankrupt in a round
}
```

#### Role B
```javascript
`${gameID}---${playerID}`: {
    connectionId: string,
    playerID: string,
    name: string,
    role: string, // "B"
    wealth: Array<number>, //starts as [0]
    rank: Array<number>, //starts as [0]
    planet: `${planetID},${planetName}`,
    income: Array<number>, // - income they recieve in a round
    declaredIncome: Array<number>, // - income they declared in a round
    audit: Array<number>, // - amount they were fined in an audit in a round
    bankrupt: Array<boolean>, // - true if their planet went bankrupt in a round
}
```

#### Role C
```javascript
${gameID}---${playerID}: {
    connectionId: string,
    playerID: string,
    name: string,
    role: string, // "C"
    wealth: Array<number>,
    rank: Array<number>,
    planet: Array<string>, //only an array for role C [`${planetID},${planetName}`]
    income: Array<number>, // - income they recieve in a round
    declaredIncome: Array<number>, // - income they declared in a round
    audit: Array<number>, // - amount they were fined in an audit in a round
    bankrupt: Array<boolean>, // - true if they went bankrupt in a round
}
```

#### Returns
```javascript
    statusCode: 200,
    body: `host [${hostID}] alerted of player [${name}] `
```

<Note>Each time a player sends a joinGame request, the host will receive the following string: `{"message":{"playerID":"001a","playerName":"Emma", "type":"[new|rejoin]"}}`</Note>

### Existing Connection
```javascript
    statusCode: 200,
    body: "{\"connectionId\":\"Zg2C4e7uliACEsg= \",\"playerID\":\"00001 \",\"name\":\"Emma \",\"role\":\"A\",\"wealth\":[0],\"rank\":[0],\"planet\":\"planet1,Quintaris\",\"taxRate\":[],\"redistributedWealth\":[],\"playerCount\":[],\"bankrupt\":[]}"
```

## startGame
startGame goes through all of the planets in the elasticache-tax-game cache, ensures that there are no planets with an awkward amount of players (checks the last planet), and then sends each player their planet (name and ID) and role.

* If there are two or less players, startGame reassigns each of them to an existing planet with the "B" role
    * The existing planets are determined by the player's position in the player array: `planetsObject[newestPlanet.players.indexOf(player)].players.push`

### Required data
```javascript
action: string, //MUST BE "game"
type: string, //MUST BE "startGame"
gameID: string
```

### Each player receives:
The planet_members array **includes** this player
`{"message":{"planetID":"planet1","planet_name":"Soralia","playerRole":"C","planet_members":["Emma","Jules","Steve","Thomas","Kelvin","Dana"]}}`

## startRound
It should be sent by the **Host**. Creates an array of items in `DynamoDBStack-WebsocketConnections87C62C57-1H8H09K1YWXHY` with the given gameID, and then sends each connection the response message.

### Required data
```javascript
action: string, //MUST BE "game",
type: string, //MUST BE "startRound"
gameID: string,
round: number
```

### Returns
#### To Host
```javascript
    statusCode: 200,
    body: `{"round":1,"stage":1,"stageStartTime":"2024-06-17T18:17:49.544Z","stageDuration":20}`
```

#### To Players
```javascript
    statusCode: 200,
    body: `{"message":{"round":1,"stage":1,"stageStartTime":"2024-06-17T17:48:58.380Z","stageDuration":20}}`
```

## handleStage & stageChanges
* `stageChanges` is sent by a player that needed to make an action during that stage:
    - At the end of stage 1, all "A" players should send a `stageChanges` request
    - At the end of stage 2, all "B" and "C" players should send a `stageChanges` request
    - At the end of stage 3, **all** players should send a `stageChanges` request
    - At the end of stage 4, "C" players should send a `stageChanges` request
* `handleStage` should be sent by the **Host** when the stage is up (stageDuration has elapsed)
    - This way, only one system is managing the time, and the WebSockets aren't using up a massive amount of processing power while each connection waits for stageDuration to elapse before sending a response.

<Warning>The WebSockets don't check if the stage duration is up. The response to `stageChanges` is sent in `handleStage`.</Warning>

### stageChanges

Response: `200 OK`

#### Stage 1
```javascript
action: "game",
type: "stageChanges",
gameID: string,
playerID: string
round: number, 
stage: number
taxRate: number,
planetID: string
```

### handleStage
#### Required Data
```javascript
action: "game",
type: "handleStage",
gameID: string,
round: number, 
stage: number //this should be the current stage | if handleStage() is being sent after stage 1, it should be 1
```

#### To Host
```javascript
    statusCode: 200,
    body: `{"round":1,"stage":1,"stageStartTime":"2024-06-17T18:17:49.544Z","stageDuration":20}`
```

#### To Players 
```javascript
    statusCode: 200,
    body: ``
```
